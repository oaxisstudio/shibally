# メッセージフォーマットガイド

## ファイル構成

```
messages/
├── nudge.json     # SessionStart時（時間外にセッション開始した場合）
└── closing.json   # Stop時（Claudeの応答完了ごと）
```

## JSONスキーマ

各メッセージファイルは以下の形式の配列：

```json
[
  {
    "id": "n001",
    "text": "メッセージ本文。{{time}} で現在時刻、{{duration}} でセッション経過時間が入る。",
    "severity": "gentle",
    "tags": ["late_night", "parent"]
  }
]
```

### フィールド定義

| フィールド | 型       | 必須 | 説明                                         |
| ---------- | -------- | ---- | -------------------------------------------- |
| `id`       | string   | ✅   | 一意のID。nudge: `n001`〜、closing: `c001`〜 |
| `text`     | string   | ✅   | メッセージ本文                               |
| `severity` | string   | ✅   | トーン。下記参照                             |
| `tags`     | string[] | ✅   | フィルタ用タグ。下記参照                     |

### severity（トーン）

| 値          | 説明                                  | 例                                           |
| ----------- | ------------------------------------- | -------------------------------------------- |
| `gentle`    | 優しい、寄り添い系                    | 「今日はもう十分頑張ったよ」                 |
| `witty`     | ユーモア、エンジニアあるある          | 「あなたの集中力、もうtoken切れてますよ」    |
| `rational`  | 論理的、データで説得                  | 「23時以降の生産性、統計的に有意に低いです」 |
| `emotional` | 感情に訴える                          | 「画面の外で、誰かがあなたを待ってるかも」   |
| `poetic`    | 詩的、余韻を残す                      | 「今夜の月、見た？」                         |
| `savage`    | グサッとくる（humor_level: high向け） | 「AIに人生相談する前に、人に話しな」         |

### tags（フィルタ用タグ）

**時間帯タグ（自動判定）:**
| タグ | 条件 |
|------|------|
| `work_hours` | 稼働時間内 |
| `after_hours` | 稼働時間外（深夜帯除く） |
| `late_night` | emergency_hours内 |
| `weekend` | 稼働曜日外 |
| `morning` | 5:00-9:00 |

**属性タグ（config.yamlのpersona.typeに対応）:**
| タグ | 対象 |
|------|------|
| `universal` | 全員に表示 |
| `parent` | 子育て中の人 |
| `single` | 独身 |
| `couple` | パートナーあり |
| `student` | 学生 |
| `engineer` | エンジニアあるある（universalと併用可） |

**セッション状態タグ（closing.json用）:**
| タグ | 条件 |
|------|------|
| `short_session` | 30分未満 |
| `long_session` | 2時間以上 |
| `marathon_session` | 4時間以上 |

### テンプレート変数

| 変数              | 展開結果                            | 使用可能ファイル |
| ----------------- | ----------------------------------- | ---------------- |
| `{{time}}`        | 現在時刻（HH:MM）                   | nudge, closing   |
| `{{duration}}`    | セッション経過時間（例: 1時間23分） | closing          |
| `{{day_of_week}}` | 曜日（例: 日曜日）                  | nudge, closing   |

## メッセージ選択ロジック

`scripts/message_picker.py` が以下の順序でフィルタ：

1. 時間帯タグで絞り込み
2. 属性タグで絞り込み（`universal` は常に含む）
3. `humor_level` に応じて `savage` を除外（low/medium時）
4. セッション状態タグで絞り込み（closing時のみ）
5. 残った候補からランダムに1つ選択

## メッセージ追加のガイドライン

### ✅ 良いメッセージ

- 気づきを与える（「あ、そうだな」と思わせる）
- ユーモアがある
- 短い（1-2文）

### ❌ NGなメッセージ

- 罪悪感を煽る（「またやってるの？」）
- 自己否定を誘発する
- 行動を否定する（「やめろ」ではなく「終わりにしよう」）
- 説教臭い
